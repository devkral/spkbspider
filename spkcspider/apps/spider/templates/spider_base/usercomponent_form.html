{% extends "spider_base/base.html" %}
{# inherits NOT from nouc_base #}

{% load i18n static spider_rdf spider_base %}

{% block title %}{% if object %}{% if object.is_index %}{% blocktrans trimmed %}
Change Login Protection{% endblocktrans %}{% else %}{% blocktrans trimmed %}
    Change Component
  {% endblocktrans %}{% endif %}{% else %}{% blocktrans trimmed %}
  Create Component
{% endblocktrans %}{% endif %}{% endblock %}


{% block extrahead %}
{{block.super}}
<script src="{% static 'node_modules/qrcode/build/qrcode.min.js' %}"></script>
{{form.media|safe}}
{% endblock %}
{# public_meta not required because it will never be used #}

{% block main_classes %}{% if not object %}{{block.super}}{% else %} w3-content w3-card-4 color-front-{{object.strength}}{% endif %}{% endblock %}
{% block body_class %}{% if not object %}{{block.super}}{% else %} color-back-{{object.strength}}{% endif %}{% endblock %}


{% block content %}
  <div class="w3-padding" style="height:120px">
    <a class="w3-left" href="{% url 'spider_base:ucomponent-list' %}">
      <i class="fas fa-arrow-up" style="margin-right:10px" aria-hidden="true"></i>{% trans 'Owned' %}
    </a>
    {% if object %}
      <span class="w3-right w3-left-align">
        <div style="margin-bottom:5px">
          <a class="" href="{% url 'spider_base:ucontent-list' id=object.id nonce=object.nonce %}">
            <i class="fas fa-list-ul" style="margin-right:10px" aria-hidden="true"></i>{% trans "Contents" %}
          </a>
        </div>
        <div style="margin-bottom:5px">
          <a class="" onclick="if(document.readyState === 'complete'){open_qrmodal();}; return false;" href="#">
            <i class="fas fa-file-export" style="margin-right:10px" aria-hidden="true"></i>{% trans 'Link/Export' %}
          </a>
        </div>
        {% if not object.is_index %}
          <div style="margin-bottom:5px">
            <a href="{% url 'spider_base:ucomponent-delete' user=object.user name=object.name nonce=object.nonce %}">
              <i class="fas fa-trash" style="margin-right:10px" aria-hidden="true"></i>{% trans 'Delete' %}
            </a>?
          </div>
        {% endif %}
        <div>
          {% trans "Strength" %}: {{object.strength}}
        </div>
      </span>
    {% endif %}
    <h1 class="w3-center">
      {% if object and form.instance.is_index %}
        {% trans 'Change Login Protection' %}
      {% elif object %}
        {% blocktrans trimmed %}
          Change Component
        {% endblocktrans %}: <b>{{form.instance}}</b>
      {% else %}
        {% trans 'Create new Component' %}
      {% endif %}
    </h1>
  </div>
  {% if object %}
    <form hidden="hidden" id="deleteForm" onsubmit="return delete_token(event)" method="post" action='{% url "spider_base:token-delete" name=object.name %}'>
      {% csrf_token %}
    </form>
  {% endif %}
  {% include "spider_base/form_errors.html" with form=form %}
  <form class="w3-padding" action="{{ request.get_full_path }}" encdata="multipart/form-data" method="post">
    {% csrf_token %}
    <data hidden="hidden" property="type" datatype="xsd:string">Component</data>
    <fieldset style="width:100%">
      <legend>
        <h1>
        {% if form.instance.id and form.instance.is_index %}
          {% trans 'Login Protection' %}
        {% else %}
          {% trans 'User Component' %}
        {% endif %}
        </h1>
      </legend>
      <div style="overflow-y: auto; max-height:300px">
        <table class="w3-table-all" width="100%" id="token_container">
          <thead>
            <tr>
              <th colspan="3" class="w3-center"><h1>{% trans 'Active Tokens' %}</h1></th>
            </tr>
            <tr>
              <th>{% trans 'Token' %}</th>
              <th>{% trans 'Valid till' %}</th>
              <th>{% trans 'Delete' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for token in object.authtokens.all %}
              {% token_expires object token as expire_date %}
              <tr>
                <td>
                  {{token.token}}
                </td>
                <td>
                  {{expire_date|date:"D, d/m/Y"}}
                </td>
                <td>
                  <input form="deleteForm" type="checkbox" name="token" value="{{token.token}}"></input>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="height:50px">
        <button class="w3-button w3-grey w3-right w3-hover-red" form="deleteForm">{% trans 'Delete' %}</button>
      </div>
      {% include "spider_base/base_form.html" with form=form %}
    </fieldset>
    {% if form.instance.id %}
    <button class="w3-button w3-grey">
      {% trans "Change" %}
    </button>
    {% endif %}
    <fieldset style="overflow-y: auto; max-height:600px">
      <legend style="bottom:100px;"><h1>{% trans 'Protections' %}</h1></legend>
      {% for prot in form.protections %}
        <div class="protection-wrapping">
          <div class="w3-padding-small w3-card w3-white">
            <h1 class="w3-center">{{prot}}</h1>
            {% include "spider_base/base_form.html" with form=prot %}
          </div>
        </div>
      {% empty%}
        <div class="protection-wrapping">
          <div class="w3-padding-small w3-card w3-orange">{% trans 'No protections: create component first' %}</div>
        </div>
      {% endfor %}
    </fieldset>
    <button class="w3-button w3-grey">
      {% if form.instance.id %}{% trans "Change" %}{% else %}{% trans "Create" %}{% endif %}
    </button>
    {% if object %}
      <a class="w3-right" href="{% url 'spider_base:ucontent-list' id=object.id nonce=object.nonce %}">
        {% trans "Contents" %}
      </a>
    {% endif %}
  </form>
{% endblock %}

{% block outercontent %}
{% if object %}
  {% url 'spider_base:ucontent-export' id=object.id nonce=object.nonce as exportlink %}
  {% include "spider_base/modalpresenter.html" %}
  <script>
    async function delete_token(event){
      event.preventDefault()
      let tokens = []
      if (event.target.token.length){
        for (let count=0; count < event.target.token.length; count++)
        {
            if (event.target.token[count].checked == true)
            {
                tokens.push(event.target.token[count].value)
            }
        }
      } else {
          if (event.target.token.checked == true)
          {
              tokens.push(event.target.token.value)
          }
      }
      let body = new URLSearchParams();
      for(let count=0; count < tokens.length; count++){
        body.append("token[]", tokens[count]);
      }
      req = new Request('{% url "spider_base:token-delete" name=object.name %}', {
          method: 'POST',
          body: body,
          credentials: "same-origin",
          headers: {
             "X-CSRFToken": event.target.csrfmiddlewaretoken.value,
         }
      });
      await fetch(req)
        .then(function(response) { return response.json(); })
        .then(function(data) {
        let tbody = document.getElementById("token_container").tBodies[0];
        while(tbody.rows.length != 0) {
          tbody.deleteRow(0);
        }
        for(let count=0; count<data["tokens"].length; count++){
          let row = tbody.insertRow();
          let cell1 = row.insertCell()
          cell1.innerText = data["tokens"][count].token
          let cell2 = row.insertCell()
          let date = new Date(data["tokens"][count].expires);
          // D d M Y
          cell2.innerText = date.toLocaleDateString("en-GB", {
            weekday: 'short', year: 'numeric', month: 'numeric', day: 'numeric'
          })
          let cell3 = row.insertCell()
          cell3.innerHTML = `<input form="deleteForm" type="checkbox" name="token" value="${data["tokens"][count].token}"></input>`
        }
        auth_token = data["admin"]
      })
      return false;
    };
  </script>
{% endif %}
{% endblock %}
